<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Karya DB Migrator</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-900 text-slate-300 p-10 font-mono">
    <div class="max-w-2xl mx-auto">
        <h1 class="text-2xl text-white font-bold mb-4">Database Migration Tool</h1>

        <div class="mb-6 p-4 border border-slate-700 rounded bg-slate-800">
            <h3 class="text-white font-bold mb-2">1. Initialize</h3>
            <button id="btn-init" class="px-4 py-2 bg-blue-600 text-white rounded">Connect to Firestore</button>
        </div>

        <div class="mb-6 p-4 border border-slate-700 rounded bg-slate-800 opacity-50 pointer-events-none" id="actions">
            <h3 class="text-white font-bold mb-2">2. Actions</h3>
            <div class="flex gap-2 flex-wrap">
                <button id="btn-seed-meta" class="px-3 py-1 bg-slate-600 text-white rounded">Seed Settings</button>
                <button id="btn-seed-users" class="px-3 py-1 bg-slate-600 text-white rounded">Seed Admin User</button>
                <button id="btn-migrate" class="px-3 py-1 bg-green-600 text-white rounded">MIGRATE DATA V2</button>
            </div>
        </div>

        <div id="log" class="h-64 bg-black p-4 rounded overflow-auto text-xs font-mono border border-slate-700">
            Waiting...</div>
    </div>

    <script type="module">
        import { db } from './js/config.js';
        import { collection, doc, setDoc, getDocs, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const log = (msg) => {
            const el = document.getElementById('log');
            el.innerHTML += `<div>> ${msg}</div>`;
            el.scrollTop = el.scrollHeight;
        };

        document.getElementById('btn-init').onclick = () => {
            log('Connected to ' + db.app.options.projectId);
            document.getElementById('actions').classList.remove('opacity-50', 'pointer-events-none');
        };

        document.getElementById('btn-seed-meta').onclick = async () => {
            await setDoc(doc(db, 'settings', 'meta'), {
                OriginType: [{ value: 'School' }, { value: 'Coaching' }, { value: 'Institute' }]
            }, { merge: true });
            log('Settings seeded.');
        };

        document.getElementById('btn-seed-users').onclick = async () => {
            // Creates a dummy entry; actual auth user must be created in Firebase Console
            await setDoc(doc(db, 'users', 'admin_placeholder'), {
                Name: "Admin User", Role: "SuperAdmin", Email: "admin@karya.com"
            });
            log('User placeholder created.');
        };

        document.getElementById('btn-migrate').onclick = async () => {
            log('Starting Migration V2 (Adding Timelines)...');
            const snap = await getDocs(collection(db, 'leads'));
            let count = 0;
            for (const d of snap.docs) {
                const data = d.data();
                const update = {};
                // Ensure Timeline Exists
                if (!data.Timeline || !Array.isArray(data.Timeline)) {
                    update.Timeline = [{
                        ts: new Date().toISOString(),
                        type: 'system',
                        note: 'Migrated from V1'
                    }];
                }
                // Ensure CreatedAt is valid timestamp
                if (!data.CreatedAt) update.CreatedAt = serverTimestamp();

                if (Object.keys(update).length > 0) {
                    await updateDoc(d.ref, update);
                    count++;
                }
            }
            log(`Migration complete. Updated ${count} documents.`);
        };
    </script>
</body>

</html>