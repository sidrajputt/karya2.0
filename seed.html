<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Karya DB Seeder (Debug Mode)</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Import Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, setDoc, collection, writeBatch } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        // Helper: Log to screen
        function log(msg, type = 'info') {
            const box = document.getElementById('logs');
            const p = document.createElement('div');
            p.className = `mb-1 font-mono text-xs ${type === 'error' ? 'text-red-600' : 'text-green-600'}`;
            p.innerText = `> ${msg}`;
            box.appendChild(p);
            box.scrollTop = box.scrollHeight;
            console.log(msg);
        }

        // Main Seed Function
        window.seed = async () => {
            const configInput = document.getElementById('config').value.trim();
            const btn = document.getElementById('btn');
            const box = document.getElementById('logs');

            box.innerHTML = ''; // Clear logs
            btn.disabled = true;
            btn.innerText = "Processing...";

            if (!configInput) {
                log("Error: Config is empty!", 'error');
                btn.disabled = false; btn.innerText = "Initialize Database";
                return;
            }

            try {
                log("Parsing Configuration...");

                let config;
                try {
                    // 1. Try Strict JSON first
                    config = JSON.parse(configInput);
                } catch (e) {
                    log("Strict JSON parse failed. Trying JS Object format...", 'info');
                    try {
                        // 2. Try parsing as a JavaScript Object (Standard Firebase format)
                        // This handles unquoted keys like: apiKey: "..."
                        config = new Function('return ' + configInput)();
                        log("Successfully parsed as JavaScript Object.", 'info');
                    } catch (e2) {
                        // 3. Last resort: Regex fix
                        log("JS Object parse failed. Trying auto-fix...", 'info');
                        const fixed = configInput.replace(/(\w+):/g, '"$1":').replace(/'/g, '"').replace(/,\s*}/g, '}');
                        try {
                            config = JSON.parse(fixed);
                            log("Auto-fixed JSON format.", 'info');
                        } catch (e3) {
                            throw new Error("Invalid Configuration Format. Please copy the object inside { ... } exactly.");
                        }
                    }
                }

                log("Initializing Firebase App...");
                const app = initializeApp(config);
                const db = getFirestore(app);
                const auth = getAuth(app);

                // 1. AUTHENTICATION
                log("Creating Admin User (admin@karya.com)...");
                let uid;
                try {
                    const userCred = await createUserWithEmailAndPassword(auth, "admin@karya.com", "123456");
                    uid = userCred.user.uid;
                    log(`Admin Auth Created! UID: ${uid}`);
                } catch (authErr) {
                    if (authErr.code === 'auth/email-already-in-use') {
                        log("Admin account already exists. proceeding to database setup...", 'info');
                        // We need a UID to link the user doc. In a real app we'd sign in, 
                        // but for seeding we can just generate a dummy ID or manually check.
                        // Ideally, you should delete the user in Auth console if you want a fresh start.
                        uid = "EXISTING_ADMIN_UID_PLACEHOLDER";
                    } else {
                        throw authErr;
                    }
                }

                const batch = writeBatch(db);

                // 2. ADMIN PROFILE
                log("Queuing Admin Profile...");
                const adminRef = doc(db, "users", uid === "EXISTING_ADMIN_UID_PLACEHOLDER" ? "admin_user_id" : uid);
                batch.set(adminRef, {
                    Name: "Super Admin",
                    Email: "admin@karya.com",
                    Phone: "9999999999",
                    Role: "admin",
                    TeamID: "admin_team",
                    CreatedAt: new Date().toISOString()
                });

                // 3. SETTINGS
                log("Queuing Settings...");
                const routes = ["Route 1 - City", "Route 2 - Village", "Route 3 - Highway"];
                routes.forEach(r => {
                    const ref = doc(collection(db, "settings"));
                    batch.set(ref, { Category: "Route", Value: r });
                });

                const courses = ["B.Tech", "MBA", "BBA", "Pharmacy"];
                courses.forEach(c => {
                    const ref = doc(collection(db, "settings"));
                    batch.set(ref, { Category: "Course", Value: c });
                });

                const sources = ["Walk-in", "Seminar", "Referral"];
                sources.forEach(s => {
                    const ref = doc(collection(db, "settings"));
                    batch.set(ref, { Category: "DataSource", Value: s });
                });

                // 4. TEAM
                log("Queuing Team...");
                const teamRef = doc(collection(db, "teams"));
                batch.set(teamRef, {
                    Name: "Alpha Squad",
                    SupervisorID: uid === "EXISTING_ADMIN_UID_PLACEHOLDER" ? "admin_user_id" : uid,
                    CreatedAt: new Date().toISOString()
                });

                // 5. COMMIT
                log("Writing to Database (this might take a moment)...");
                await batch.commit();

                log("‚úÖ SUCCESS! Database seeded successfully.");
                log("üëâ You can now use these credentials to login:");
                log("   Email: admin@karya.com");
                log("   Pass:  123456");

            } catch (e) {
                log("‚ùå ERROR: " + e.message, 'error');
                console.error(e);
            } finally {
                btn.disabled = false;
                btn.innerText = "Initialize Database";
            }
        };
    </script>
</head>

<body class="bg-slate-100 flex items-center justify-center h-screen font-sans">
    <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg border border-slate-200">
        <h2 class="text-2xl font-bold mb-2 text-slate-800">üöÄ Karya DB Seeder</h2>
        <p class="text-sm text-slate-500 mb-4">Paste your Firebase Config JSON below. Ensure keys are quoted.</p>

        <textarea id="config"
            class="w-full h-32 p-3 border border-slate-300 rounded-lg text-xs font-mono mb-4 focus:ring-2 focus:ring-blue-500 outline-none"
            placeholder='{
  "apiKey": "AIzaSy...",
  "authDomain": "project-id.firebaseapp.com",
  "projectId": "project-id",
  ...
}'></textarea>

        <div id="logs"
            class="bg-slate-900 text-green-400 p-3 rounded-lg h-40 overflow-y-auto mb-4 text-xs border border-slate-800">
            <div class="opacity-50">Logs will appear here...</div>
        </div>

        <button id="btn" onclick="seed()"
            class="w-full py-3 bg-blue-600 hover:bg-blue-700 transition text-white rounded-lg font-bold shadow-lg">
            Initialize Database
        </button>
    </div>
</body>

</html>